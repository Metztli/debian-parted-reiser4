From 7f2a9b572ca3627abf0d1fc8d77156c427ce7269 Mon Sep 17 00:00:00 2001
From: Jim Meyering <meyering@redhat.com>
Date: Fri, 28 Mar 2014 17:10:07 +0000
Subject: Fix constraint for very small devices (smaller than 1 cylinder)

Origin: upstream, http://git.debian.org/?p=parted/parted.git;a=commitdiff;h=9f5b0608611eed40ef33be2096f5d482710602e5
Bug-Debian: http://bugs.debian.org/602568
Forwarded: not-needed
Last-Update: 2010-11-19

Patch-Name: tiny-disk-constraint.patch
---
 libparted/labels/dos.c | 14 +++++++-------
 1 file changed, 7 insertions(+), 7 deletions(-)

diff --git a/libparted/labels/dos.c b/libparted/labels/dos.c
index bd6cb79..ef8c837 100644
--- a/libparted/labels/dos.c
+++ b/libparted/labels/dos.c
@@ -1656,13 +1656,13 @@ _primary_constraint (const PedDisk* disk, const PedCHSGeometry* bios_geom,
 			       		dev->length - min_geom->end))
 			return NULL;
 	} else {
-		/* Do not assume that length is larger than 1 cylinder's
-		   worth of sectors.  This is useful when testing with
-		   a memory-mapped "disk" (a la scsi_debug) that is say,
-		   2048 sectors long.  */
-		if (cylinder_size < dev->length
-		    && !ped_geometry_init (&start_geom, dev, cylinder_size,
-					   dev->length - cylinder_size))
+		/* Use cylinder_size as the starting sector number
+		   when the device is large enough to accommodate that.
+		   Otherwise, use sector 1.  */
+		PedSector start = (cylinder_size < dev->length
+				   ? cylinder_size : 1);
+		if (!ped_geometry_init (&start_geom, dev, start,
+					dev->length - start))
 			return NULL;
 		if (!ped_geometry_init (&end_geom, dev, 0, dev->length))
 			return NULL;
